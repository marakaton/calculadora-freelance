version: '3'

services:
  # 1. Contenedor que descarga el código (init container)
  git-puller:
    image: alpine:latest
    container_name: git_puller
    restart: always
    # Script inteligente: Bucle infinito que actualiza cada 60s sin borrar todo
    command: >
      /bin/sh -c "apk add --no-cache git ca-certificates && while true; do
        if [ -d /data/.git ]; then
          echo 'Repo detectado. Buscando actualizaciones...' && cd /data && git pull;
        else
          echo 'Carpeta vacia o corrupta. Clonando desde cero...' && 
          rm -rf /data/* /data/.* 2>/dev/null || true && 
          git clone https://github.com/marakaton/calculadora-freelance.git /data;
        fi;
        echo 'Todo actualizado. Durmiendo 60 segundos...' && sleep 60;
      done"
    volumes:
      - web-content:/data
    networks:
      - bridge

  # 2. Servidor web que lee el código descargado
  web:
    image: nginx:alpine
    container_name: freelance_calculator
    restart: always
    # Eliminamos puertos expuestos para usar SOLO Caddy
    # ports:
    #  - "53000:80"
    expose:
      - "80"
    volumes:
      - web-content:/usr/share/nginx/html
    depends_on:
      - git-puller

    # Configuración de Red igual que Nobella
    networks:
      - network_general_internal
      - bridge

    # Configuración de Caddy (Copiada de Nobella)
    deploy:
      mode: replicated
      replicas: 1
      labels:
        container_port: "80"
        caddy: freelancecalc.net, www.freelancecalc.net
        caddy.reverse_proxy: "{{index .Service.Labels \"container_port\"}}"
        # Esto sobreescribe la configuración global de DNS para este sitio específico
        # Caddy usará el método estándar (HTTP/TLS)
        caddy.tls.ca: "https://acme-v02.api.letsencrypt.org/directory"

volumes:
  web-content:


networks:
  network_general_internal:
    external: true
  bridge:
    external: true
